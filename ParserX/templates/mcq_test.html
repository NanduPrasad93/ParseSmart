<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCQ Test</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        .question-container { margin: 20px auto; max-width: 600px; text-align: left; }
        .options label { display: block; margin: 5px 0; }
        button { margin-top: 10px; padding: 10px 20px; cursor: pointer; }
        .timer { font-size: 1.5em; font-weight: bold; margin: 20px; }
        .loading { font-size: 1.2em; color: #555; }
        .error { color: red; font-weight: bold; }
        .result { margin-top: 20px; padding: 20px; background-color: #f9f9f9; border: 1px solid #ddd; text-align: left; }
    </style>
</head>
<body>

    <h1>MCQ Test</h1>
    <div class="timer" id="timer">Time Left: 10:00</div>
    <select id="categorySelect">
        <!-- Categories will be populated dynamically -->
    </select>
    <button onclick="loadQuestions()">Start Test</button>

    <div id="mcqContainer" class="question-container">
        <p class="loading">Select a category and click "Start Test" to begin.</p>
    </div>
    <button onclick="submitAnswers()">Submit Answers</button>

    <div id="resultContainer" class="result" style="display: none;">
        <h2>Test Results</h2>
        <p id="score"></p>
        <div id="detailedResults"></div>
    </div>

    <script>
        let mcqs = [];
        let timeLeft = 600; // 10 minutes in seconds
        let timerInterval;

        // Function to start the timer
        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                document.getElementById("timer").textContent = `Time Left: ${minutes}:${seconds.toString().padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitAnswers();
                }
            }, 1000);
        }

        // Function to load categories dynamically
        function loadCategories() {
            fetch("/api/categories/")
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById("categorySelect");
                    select.innerHTML = data.map(category => `<option value="${category}">${category}</option>`).join("");
                })
                .catch(error => console.error("Error loading categories:", error));
        }

        // Function to load questions
        function loadQuestions() {
            const category = document.getElementById("categorySelect").value;
            const container = document.getElementById("mcqContainer");
            container.innerHTML = "<p class='loading'>Loading questions...</p>";

            fetch(`/api/mcq/${category}/`)
                .then(response => response.json())
                .then(data => {
                    if (!data || data.length === 0) {
                        container.innerHTML = "<p class='error'>No questions available for this category.</p>";
                        return;
                    }
                    mcqs = data;
                    displayQuestions();
                    startTimer(); // Start the timer when questions are loaded
                })
                .catch(error => {
                    console.error("Error loading questions:", error);
                    container.innerHTML = "<p class='error'>Failed to load questions. Please try again.</p>";
                });
        }

        // Function to display questions
        function displayQuestions() {
            const container = document.getElementById("mcqContainer");
            container.innerHTML = "";
        
            mcqs.forEach((mcq, index) => {
                container.innerHTML += `
                    <div class="question">
                        <p><b>${index + 1}. ${mcq.question}</b></p>
                        <div class="options">
                            <label><input type="radio" name="q${index}" value="${mcq.option_a}"> ${mcq.option_a}</label>
                            <label><input type="radio" name="q${index}" value="${mcq.option_b}"> ${mcq.option_b}</label>
                            <label><input type="radio" name="q${index}" value="${mcq.option_c}"> ${mcq.option_c}</label>
                            <label><input type="radio" name="q${index}" value="${mcq.option_d}"> ${mcq.option_d}</label>
                        </div>
                    </div>
                    <hr>
                `;
            });
        }
        

        function submitAnswers() {
            clearInterval(timerInterval); // Stop the timer
            let score = 0;
            let unanswered = 0;
            let resultsHTML = "";
        
            mcqs.forEach((mcq, index) => {
                const selected = document.querySelector(`input[name="q${index}"]:checked`);
                let selectedOption = "Unanswered";
                let correctOption = mcq.correct_option.trim().toUpperCase();
                let isCorrect = false;
        
                if (selected) {
                    selectedOption = selected.value.trim().toUpperCase();
                    isCorrect = selectedOption === correctOption;
                    if (isCorrect) score++;
                } else {
                    unanswered++;
                }
        
                // Display only the selected answer and whether it was correct
                resultsHTML += `
                    <p><b>Q${index + 1}:</b> ${mcq.question}</p>
                    <p><b>Your Answer:</b> ${selectedOption}</p>
                    <p><b>Correct Answer:</b> ${correctOption}</p>
                    <p><b>Status:</b> ${isCorrect ? "<span style='color:green;'>Correct ✅</span>" : "<span style='color:red;'>Incorrect ❌</span>"}</p>
                    <hr>
                `;
            });
        
            // Display results
            document.getElementById("score").innerHTML = `<b>Your Score: ${score} / ${mcqs.length}</b>`;
            document.getElementById("detailedResults").innerHTML = resultsHTML;
        
            if (unanswered > 0) {
                document.getElementById("detailedResults").innerHTML += `<p><b>You left ${unanswered} questions unanswered.</b></p>`;
            }
        
            document.getElementById("resultContainer").style.display = "block";
        }
               // Load categories when the page loads
        window.onload = loadCategories;
    </script>

</body>
</html>